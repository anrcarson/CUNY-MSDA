---
title: "Final Project: State and National Population and Voting Trends"
author: "Andrew Carson"
date: "December 18, 2016"
output:
  html_document:
      highlight: tango
      theme: united
---
#### Introduction
Do state populations bear any relationship to state voter turnouts and party selections in presidential elections?  What can we learn about voter turnout and state party preference based on state populations?  I intend to answer these questions in my exploration of state population data from 1900 through 2016 in comparison to state voting percentages and party selection from 1900 through 2016.  I will use census data and federal elections data to do the analysis.  This data is available on the web.  I will download, clean, transform, analyze, and visualize the data using R and R Markdown.


#### Gather Data

Gathering the data was quite difficult and required a great deal of code due to the many source files from the Census Bureau and the many slightly varying webpages containing Presidential election data at the national and state levels.  Consequently, I have placed that code in a separate file, located here: [GitHub](https://github.com/anrcarson/CUNY-MSDA/blob/master/DATA607/FinalProject/final_project_getdata.Rmd) [RPubs](http://rpubs.com/anrcarson/232668).

#### Clean/Transform Data
  
The code referenced in the above section output many different .csv files to my local computer, which I have placed in [GitHub](https://github.com/anrcarson/CUNY-MSDA/tree/master/DATA607/FinalProject).  After joining similar files together, I have these 5 master files to use in the following analyses:

1. `state_population_1900_2015.csv`: Every state's population from 1900 through 2015

2. `national_population_1900_2016.csv`: The United State's national population from 1900 through 2016.

3. `state_header_df.csv`: The year and Presidential candidate names for each presidential election 1824 - 2016.  This matches with the file `summary_state_df.csv`.

4. `summary_state_df.csv`: The year and total votes cast by state for each Presidential candidate from 1824 - 2016.  This matches with the file `state_header_df.csv`.

5. `summary_df.csv`: The year, party, Presidential Candidate, Vice Presidential Candidate, Electoral Votes, Electoral Percentage, Popular Votes, and Popular Vote Percentage for each Presidential candidate from 1789 - 2016.


```{r, eval=TRUE, echo=FALSE, message = FALSE, warning=FALSE}

#check for packages to install and install them if missing
packages <- c("tidyr", "dplyr", "stringr", "knitr", "ggplot2", "maps", "mapdata", "rvest","XML")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}

library(tidyr)
library(dplyr)
library(stringr)
library(knitr)


#1. state_population_1900_2015.csv
data<-read.csv("https://raw.githubusercontent.com/anrcarson/CUNY-MSDA/master/DATA607/FinalProject/state_population_1900_2015.csv", stringsAsFactors = FALSE)

#keep states, remove regions
data<-data[6:56,]

#remove index field
data$X<-NULL

#remove "," from value fields, cast to numeric
data[,2:ncol(data)]<-data.frame(lapply(lapply(data[,2:ncol(data)],str_replace_all,",",""),as.numeric), stringsAsFactors = FALSE)

#remove all census entries, extra columns, etc.
data[,str_detect(names(data),"census")]<-NULL
data$X1980.y<-NULL
data$X1990.x<-NULL
data$X2010.x<-NULL
data$EstimatesBase<-NULL

#clean up column names
names(data)[2:ncol(data)]<-str_replace_all(names(data[,2:ncol(data)]),"[:alpha:]","")
names(data)[2:ncol(data)]<-str_replace_all(names(data[,2:ncol(data)]),"[:punct:]","")

#gather years
state_population<-gather(data,"Year","Population",2:117)

#cast Year to numeric
state_population$Year<-as.numeric(state_population$Year)

#remove NAs
state_population<-subset(state_population, !is.na(Population))

#project 2016 numbers for each state using past 6 years
predict_df<-c()
for(state in unique(state_population$State)){
  
  #state<-"AL"
  temp<-subset(state_population, State==state & Year>=2010)
  model<-lm(Population~Year, data=temp)
  df<-c()
  df<-data.frame(rbind(df,c(state,NA,2016)), stringsAsFactors = FALSE)
  names(df)<-c("State","Population","Year")
  df$Year<-as.numeric(df$Year)
  df$Population<-predict(model, df)
  
  predict_df<-rbind(predict_df,df)
  
}

state_population<-rbind(state_population,select(predict_df, State, Year, Population))

#######################

#2. national_population_1900_2016.csv

data<-read.csv("https://raw.githubusercontent.com/anrcarson/CUNY-MSDA/master/DATA607/FinalProject/national_population_1900_2016.csv", stringsAsFactors = FALSE)

#remove index
data$X<-NULL

#remove "," from value fields, cast to numeric
data$NationalPopulation<-as.numeric(str_replace_all(data$NationalPopulation,",",""))

#get Year from Date, remove date
data$Year<-as.numeric(str_extract(data$Date,"[0-9]{2,}"))
data$Date<-NULL

#rearrange
data<-select(data,Year, NationalPopulation)

#rename population column
names(data)[2]<-"Population"

#assign to data frame
national_population<-data

############################

#3. state_header_df.csv
data<-read.csv("https://raw.githubusercontent.com/anrcarson/CUNY-MSDA/master/DATA607/FinalProject/state_header_df.csv", stringsAsFactors = FALSE)

#remove index
data$X<-NULL

#remove extra columns
data<-data[,1:5]

#remove party affiliation from candidate names
party_affiliation<-c("Democratic", "Republican", "American", "Independent","Green","Libertarian","Reform", "Democrat")

for (i in 1:length(party_affiliation)){
data[,2:ncol(data)]<-
  data.frame(lapply(data[,2:ncol(data)],str_replace_all,party_affiliation[i],""), stringsAsFactors = FALSE)  
  
}

#remove white space
data[,2:ncol(data)]<-
  data.frame(lapply(data[,2:ncol(data)],str_trim), stringsAsFactors = FALSE) 

#assign to final data frame
state_election_header<-data

############################

#4. `summary_state_df.csv`
data<-read.csv("https://raw.githubusercontent.com/anrcarson/CUNY-MSDA/master/DATA607/FinalProject/summary_state_df.csv", stringsAsFactors = FALSE)

#remove index
data$X<-NULL

#remove "Â" from fields
data[,2:ncol(data)]<-data.frame(lapply(data[,2:ncol(data)],str_replace_all,"Â",""), stringsAsFactors = FALSE)

#remove State "Totals", "Total" rows and "" rows
data<-subset(data, !is.na(State) & State != "Totals" & State != "" & State != "Total" )

#remove "," from value fields
data[,3:ncol(data)]<-data.frame(lapply(data[,3:ncol(data)],str_replace_all,",",""), stringsAsFactors = FALSE)

#clean Total Votes
data$TotalVotes<-as.numeric(str_extract(data$TotalVotes,"[0-9]{3,}"))

#remove % from value columns
data[,3:ncol(data)]<-data.frame(lapply(data[,3:ncol(data)],str_replace_all,"%",""), stringsAsFactors = FALSE)

#remove * from value columns
data[,2:ncol(data)]<-data.frame(lapply(data[,2:ncol(data)],str_replace_all,"\\*",""), stringsAsFactors = FALSE)

#cast as numeric
data[,3:ncol(data)]<-data.frame(lapply(data[,3:ncol(data)],as.numeric), stringsAsFactors = FALSE)

#rename columns
names(data)<-c("Year","State","TotalPopularVote"
               ,"Candidate1PopVotes","Candidate1PVPerc","Candidate1EV"
               ,"Candidate2PopVotes","Candidate2PVPerc","Candidate2EV"
               ,"Candidate3PopVotes","Candidate3PVPerc","Candidate3EV"
               ,"Candidate4PopVotes","Candidate4PVPerc","Candidate4EV")


#change state names to abbreviations
state_mapping<-read.csv("https://raw.githubusercontent.com/anrcarson/CUNY-MSDA/master/DATA607/FinalProject/state_mapping.csv", stringsAsFactors = FALSE)
data[which(data$State =="New jersey"),]$State <-"New Jersey"
data[which(data$State =="Dist. of Col."),]$State <-"District of Columbia"
data<-full_join(state_mapping,data, by=c("StateFullName" = "State"))
data$StateFullName<-NULL
names(data)[1]<-"State"
data<-subset(data, !is.na(Year))


#assign to final dataframe
state_election_data<-data


############################


#5. summary_df.csv
data<-read.csv("https://raw.githubusercontent.com/anrcarson/CUNY-MSDA/master/DATA607/FinalProject/summary_df.csv", stringsAsFactors = FALSE)

#remove index
data$X<-NULL

#remove "Â" from fields
data[,2:ncol(data)]<-data.frame(lapply(data[,2:ncol(data)],str_replace_all,"Â",""), stringsAsFactors = FALSE)

#remove empty rows
data<-subset(data, !is.na(Party))

#cast ElectoralVote to numeric
data$ElectoralVote<-as.numeric(data$ElectoralVote)

#cast ElectoralPerc to numeric
data$ElectoralPerc<-as.numeric(str_replace_all(data$ElectoralPerc,"[%-]",""))

#cast PopularVote to numeric
data$PopularVote<-as.numeric(str_replace_all(data$PopularVote,",",""))

#cast PopularPerc to numeric
data$PopularPerc<-as.numeric(str_trim(str_replace_all(data$PopularPerc,"[%]","")))

#assign to final df
national_election<-data


###########################
#cleanup
data<-NULL

```

##### Verify Data

Before moving on, let's verify the data that we have.

We have the state populations for each year 1900-2015.  In 2015, CA has the largest state population at 39144818, followed by TX at 27469114 and FL at 20271272.  The least populated states are WY (586107), VT (626042), and AK (738432).

```{r, eval=TRUE}

#state population
kable(head(state_population))
state_population %>% subset(Year==2015)%>%arrange(desc(Population))%>% head() %>%kable()
state_population %>% subset(Year==2015)%>%arrange(desc(Population))%>% tail() %>%kable()
```

We confirm that we have the national population from 1900-2016.  The US population in 2016 was almost 324 million.  Also shown below are the heads of the national election and state election files.

```{r,eval=TRUE}
#national population
kable(head(arrange(national_population, desc(Population))))

#national election
kable(head(national_election))

#state election
kable(head(state_election_data))
kable(head(state_election_header))

```


#### Exploratory Data Analysis

##### Population

As visible below, the United States population has steadily increased since 1900. We can see slight changes during WWI and WWII in which the population growth slowed and then was followed by a boom.  Since then, the growth rate has been pretty consistent.  (Note: there is a slight jump between 1999 and 2000 due to a change in the data source.)

```{r,eval=TRUE,echo=FALSE,message=FALSE, fig.align="center", warning=FALSE}
library(ggplot2)
library(maps)
library(mapdata)

#Note: referenced "http://stackoverflow.com/questions/26540955/maps-ggplot2-fill-by-state-is-missing-certain-areas-on-the-map" for code help"

#get mapping coordindates for US
all_states <- map_data("state")
alaska<-map_data("world", regions = "USA:Alaska")
hawaii<-map_data("world", regions = "USA:Hawaii")

#adjust order/group
alaska$order<-max(all_states$order) + alaska$order
alaska$group<-max(all_states$group) + alaska$group
hawaii$order<-max(alaska$order) + hawaii$order
hawaii$group<-max(alaska$group) + hawaii$group

#move alaska
alaska$region<-"alaska"
alaska$long<-alaska$long + 40
alaska$long[alaska$long>0]<-alaska$long[alaska$long>0] - 360
alaska$lat<-alaska$lat-35

#move hawaii
hawaii$region<-"hawaii"
hawaii$lat<-hawaii$lat + 3
hawaii$long<-hawaii$long + 70

#rescale alaska
alaska$lat<-(alaska$lat-mean(alaska$lat))/3 + mean(alaska$lat)
alaska$long<-(alaska$long-mean(alaska$long))/3 + mean(alaska$long)

#combine into single df
all_states_al_hi<-rbind(all_states,alaska,hawaii)

#assign back to all_states
all_states<-all_states_al_hi


#national population
qplot(x = Year, y = Population, data = national_population, ylim = c(0,350000000), main = "National Population By Year") + geom_smooth(method="lm")

```

At the state level, we can see that several states have very large and growing populations (CA, FL, TX)  while others appear to have plateaued (NY, DC, WV).  This is easier to see in the second plot, which frees the y axis to the appropriate scale for each state.  We can also see periods of rapid change.  ND in particular is interesting in that it experience rapid growth, rapid decline, slow growth, and then recently, extremely rapid growth (due to oil fracking industry).

```{r,eval=TRUE,echo=FALSE,message=FALSE, fig.width=10, fig.height=10}
#states population
qplot(x = Year, y = Population, data = state_population, main = "State Population By Year") + facet_wrap(~State)

```

```{r,eval=TRUE,echo=FALSE,message=FALSE, fig.width=10, fig.height=10}
qplot(x = Year, y = Population, data = state_population, main = "State Population By Year (Variable Population)") + facet_wrap(~State, ncol=5,scales = "free_y")
```

What about state population as a ratio to the national population?  We can see that several states have increased over time (CA, TX, FL) while others have decreased (NY, PA, IL).  This again is easier to see when the y axis is free, which reveals many very interesting population changes in states.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
#create variables for voting to be used later
sum_PopularVote_state<-state_election_data %>% group_by(State, Year) %>% summarise(SumPopularVote = sum(TotalPopularVote, na.rm = TRUE))
state<-full_join(sum_PopularVote_state, state_population, by=c("State", "Year"))
state$Ratio<-state$SumPopularVote/state$Population

#join state data to national data
state<-full_join(state,national_population, by="Year")
names(state)<-c("State","Year","SumPopularVote","StatePopulation","Ratio","NationalPopulation")
state$PopulationRatio<-state$StatePopulation/state$NationalPopulation

#state population ratio to national population
qplot(x = Year, y = PopulationRatio, data = state, xlim = c(1900,2016), ylim=c(0,.15), main="State Population Ratio Over Time") + facet_wrap(~State, ncol=5) + geom_smooth()


qplot(x = Year, y = PopulationRatio, data = state, xlim = c(1900,2016), main="State Population Ratio Over Time (Free Population Ratio)") + facet_wrap(~State,scales = "free_y", ncol=5) + geom_smooth()


```

We can visualize the above information differently using a map of the United States.  This first map shows that change in absolute population for each state from 1900-2016.  The map starts dark in 1900, but various states begin to emerge as their populations increase.  Early on we can see NY, PA, IL, and TX emerging.  CA begins to be noticeable in the 1920s.  FL becomes more noticeable in the 1980s.  Today, we can see that CA, TX, FL, NY, and IL have large populations.

```{r,eval=TRUE,echo=FALSE,message=FALSE, fig.width=10, fig.height=25}

#state population changes over time
state_mapping$StateFullName_lower<-tolower(state_mapping$StateFullName)
state_population_map<-left_join(all_states,state_mapping,by=c("region" = "StateFullName_lower"))
state_population_map<-left_join(state_population_map,state,by=c("StateAbbreviation" = "State"))

#reorder for plotting
state_population_map<-arrange(state_population_map, Year, order)

#state population over time
qplot(long, lat, geom="polygon", data=subset(state_population_map,Year>=1900),  fill=StatePopulation, group=group, main = "State Population Over Time") + facet_wrap(~Year, ncol=5)


```

In this second map, we visualize the population ratio, that is, the state population ratio to the national population.  As noted above, we can see that New England states and IL start off having the largest percentage of US residents.  But very early on we can see the rising importance of CA and TX.  CA has had the largest proportion of US residents since the 1970s.

```{r,eval=TRUE,echo=FALSE,message=FALSE, fig.width=10, fig.height=25}
#state/national population ratio over time
qplot(long, lat, geom="polygon", data=subset(state_population_map,Year>=1900),
fill=PopulationRatio, group=group, main = "State Population Ratio Over Time") + facet_wrap(~Year, ncol=5)
```

###### Voting

What about voting trends?  At the national level since 1789, the maximum electoral percentage for any candidate in a given voting year has jumped around wildly.  But a very loose trend (as given by `geom_smooth`) would suggest that voters were more unified at the founding with a decline bottoming out right before the civil war.  Electoral percentage for the winning candidate increase about 1950, when politics began to get more divisive again.  This brings us to the most recent election, which was also very divisive.

Notice the only dot below 50% occurred in 1824 in a contest between between Andrew Jackson and John Quincy Adams.  While Jackson got more electoral votes, the election went to the House of Representatives for a vote because no candidate got a majority.  Adams was then elected President by the House.


```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.align="center"}
#national election
max_ElectoralPerc<-national_election %>% group_by(Year) %>% summarise(max(ElectoralPerc))
qplot(x = Year, y = `max(ElectoralPerc)`, data = max_ElectoralPerc, main = "National Election Maximum Electoral Percentage Over Time") + geom_smooth()
```

The popular vote percentage tells a similar story, but perhaps less extreme because it is the popular vote percentages as opposed to electoral vote percentages.  We can see that the highest popular vote percentage was 61% in 1964 by Lyndon B. Johnson.  The least was in 1860, when Abraham Lincoln received only 39.9% of the popular vote.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.align="center"}
max_PopularPerc<-national_election %>% group_by(Year) %>% summarise(max(PopularPerc))
qplot(x = Year, y = `max(PopularPerc)`, data = subset(max_PopularPerc,Year>=1824), main = "National Election Maximum Popular Percentage Over Time") + geom_smooth()

kable(head(arrange(max_PopularPerc,desc(`max(PopularPerc)`))))
kable(head(arrange(max_PopularPerc,`max(PopularPerc)`)))

```


How does the national population relate to the national popular vote?  As you can see by the graphs below, the relationship is very linear.  This is not especially uprising, for as the population increases, so does the voting population.  What is more revealing is that a look at the ratio of popular vote to population over time shows that this ratio is increasing. The trend is not perfect (people voted less prior to and during WWI), but overall we see an increase in voting rate that is slowing over time.  In other words, more people are voting in each election, but that increase is getting relatively smaller and smaller.  Perhaps the ratio will get closer to 45%, but never pass over.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.align="center"}
#national population vs. national election
sum_PopularVote<-national_election %>% group_by(Year) %>% summarise(SumPopularVote = sum(PopularVote, na.rm = TRUE))
national<-full_join(sum_PopularVote, national_population, by="Year")
national$Ratio<-national$SumPopularVote/national$Population

qplot(x = Population, y = SumPopularVote, data = national, main = "Population vs. Popular Vote") + geom_smooth(method = "lm")
qplot(x = Year, y = Ratio, data = national, xlim = c(1900,2016), ylim=c(0,.5), main = "Popular Vote Turnout Ratio Over Time") + geom_smooth(method = "glm", formula = y~poly(x,3))

```

Why might the voting ratio be increasing over time?  We know that the population is increasing over time, as is the population density.  Below I calculate the population density.  You can see from a simple linear model that `Year` is a better predictor of the ratio, but `PopulationDensity` is pretty good too.  We will come back to that later.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.align="center"}
national$ContiguousSquareMiles<-2959064
national$PopulationDensity<-national$Population/national$ContiguousSquareMiles
qplot(x = PopulationDensity, y = Ratio, data = national, ylim=c(0,.5), main="Population Density vs. Voter Turnout Ratio") + geom_smooth(method = "glm", formula = y~poly(x,3))

summary(lm(Ratio~Year, data=national))
summary(lm(Ratio~PopulationDensity, data=national))
```

At the state level, we can also view trends in voting percentages.  The below plot shows that most states do have an increasing popular vote to state population ratio over time, but that it has slowed in recent years or plateaued.  Others do not, however.  CA appears to have peaked at 47% in 1940 and has declined since.  HI has been relatively flat at 32% since it become a state. Overall, it looks like southern states have continued to increase in their voting ratios while northern and western states have not or have slowed dramatically.  I would suspect that the civil war and civil rights movements can explain much of the initial low turnout and the subsequent increase in the south.

Maine has had the highest ratio at 56% in 2004.  At present, MN has the highest at 54%. The lowest historically was SC in 1924 at 3%.  In 2012, the lowest was TX at 31%.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
#state population vs. state election

qplot(x = Year, y = Ratio, data = subset(state, Year<=2015), xlim = c(1900,2016), ylim=c(0,.5), main="Voter Turnout Ratio By State Over Time") + facet_wrap(~State, ncol=5) + geom_smooth()

kable(head(arrange(state,desc(Ratio))))
kable(head(arrange(state,Ratio)))
kable(head(arrange(subset(state, Year==2012),Ratio)))
```

We can also visualize this information using a map of the United States.  As mentioned above, it looks like most states but particularly the south had little voter turnout before 1920.  After 1920, the south continued to have low voter turnout until the 1960s.  Since then, the south has come to have voter turnout similar to all other states.  (Note: data for the 2016 election was not fully published by several states as of the final data pull on 12/15/16.  Consequently, these states have a "0%" voter turnout ratio.)

```{r,eval=TRUE,echo=FALSE,message=FALSE,fig.width=10, fig.height=10}
#state voting ratio over time
qplot(long, lat, geom="polygon", data=subset(state_population_map, Year>=1900 & Year%%4==0),
  facets=~Year, fill=Ratio, group=group, main="Voter Turnout Ratio By State Over Time")
```


What about candidates and parties?  We use the below code to find the winning candidate and party for each state for each voting year from 1824 - 2016.

```{r,eval=TRUE,echo=FALSE,message=FALSE}

# join state election data and state header
state_election_full<-full_join(state_election_data, state_election_header, by="Year")
WinningCandidate<-c()

#determine popular vote winner and party
for (i in 1:nrow(state_election_full)){

  if(state_election_full$Year[i] != 2016){
  
  #i<-2
  #get max popular vote
   maxcandidate<-0
   max_vote_row<-0
   #check 1
   if(replace(state_election_full$Candidate1PopVotes[i], is.na(state_election_full$Candidate1PopVotes[i]),0)>max_vote_row){
     maxcandidate<-1
     max_vote_row<-state_election_full$Candidate1PopVotes[i]
   }


   #check 2
   if(replace(state_election_full$Candidate2PopVotes[i], is.na(state_election_full$Candidate2PopVotes[i]),0)>max_vote_row){
     maxcandidate<-2
     max_vote_row<-state_election_full$Candidate2PopVotes[i]
   }
  #check 3
   if(replace(state_election_full$Candidate3PopVotes[i], is.na(state_election_full$Candidate3PopVotes[i]),0)
              >max_vote_row){
     maxcandidate<-3
     max_vote_row<-state_election_full$Candidate3PopVotes[i]
   }
  #check 4
   if(replace(state_election_full$Candidate4PopVotes[i], is.na(state_election_full$Candidate4PopVotes[i]),0)>max_vote_row){
     maxcandidate<-4
     max_vote_row<-state_election_full$Candidate4PopVotes[i]
   }


  #match to candidate
  WinningCandidate<-c(WinningCandidate,state_election_full[i,15+maxcandidate])

  } else{ #FOR 2016 Use EV
    
    #i<-2
  #get max popular vote
   maxcandidate<-0
   max_vote_row<-0
   #check 1
   if(replace(state_election_full$Candidate1EV[i], is.na(state_election_full$Candidate1EV[i]),0)>max_vote_row){
     maxcandidate<-1
     max_vote_row<-state_election_full$Candidate1EV[i]
   }


   #check 2
   if(replace(state_election_full$Candidate2EV[i], is.na(state_election_full$Candidate2EV[i]),0)>max_vote_row){
     maxcandidate<-2
     max_vote_row<-state_election_full$Candidate2EV[i]
   }
  #check 3
   if(replace(state_election_full$Candidate3EV[i], is.na(state_election_full$Candidate3EV[i]),0)
              >max_vote_row){
     maxcandidate<-3
     max_vote_row<-state_election_full$Candidate3EV[i]
   }
  #check 4
   if(replace(state_election_full$Candidate4EV[i], is.na(state_election_full$Candidate4EV[i]),0)>max_vote_row){
     maxcandidate<-4
     max_vote_row<-state_election_full$Candidate4EV[i]
   }


  #match to candidate
  WinningCandidate<-c(WinningCandidate,state_election_full[i,15+maxcandidate])  
    
    
    
  }
  
  
  
  #print(i)
}


#clean WinningCandidate to match on join
WinningCandidate[which(WinningCandidate=="JACKSON")]<-"Andrew Jackson"
WinningCandidate[which(WinningCandidate=="ADAMS")]<-"John Quincy Adams"
WinningCandidate[which(WinningCandidate=="ADLAI E. STEVENSON")]<-"Adlai Stevenson"
WinningCandidate[which(WinningCandidate=="AL GORE")]<-"Albert Gore, Jr."
WinningCandidate[which(WinningCandidate=="BARRY M. GOLDWATER")]<-"Barry Goldwater"
WinningCandidate[which(WinningCandidate=="BILL CLINTON")]<-"William J. Clinton"
WinningCandidate[which(WinningCandidate=="CLAY")]<-"Henry Clay"
WinningCandidate[which(WinningCandidate=="CRAWFORD")]<-"William H. Crawford"
WinningCandidate[which(WinningCandidate=="GEORGE B. McCLELLAN")]<-"George McClellan"
WinningCandidate[which(WinningCandidate=="HERBERT C. HOOVER")]<-"Herbert Hoover"
WinningCandidate[which(WinningCandidate=="HORACE GREEFLEY")]<-"Horace Greeley"
WinningCandidate[which(WinningCandidate=="JAMES G. BLAINE")]<-"James G. Blane"
WinningCandidate[which(WinningCandidate=="JOHN C. BRECKINRIDGE")]<-"John Breckenridge"
WinningCandidate[which(WinningCandidate=="JOHN Q. ADAMS")]<-"John Quincy Adams"
WinningCandidate[which(WinningCandidate=="MICHAEL S. DUKAKIS")]<-"Michael Dukakis"
WinningCandidate[which(WinningCandidate=="ROBERT M. LA FOLLETTE")]<-"Robert LaFollette"
WinningCandidate[which(WinningCandidate=="SAMUEL J. TILDEN")]<-"Samuel Tilden"
WinningCandidate[which(WinningCandidate=="STEPHEN A. DOUGLAS")]<-"Stephen Douglas"
WinningCandidate[which(WinningCandidate=="WENDELL WILLKIE")]<-"Wendell L. Willkie"
WinningCandidate[which(WinningCandidate=="WILLIAM H. HARRISON")]<-"William Henry Harrison"
WinningCandidate[which(WinningCandidate=="WILLIAM H. TAFT")]<-"William Howard Taft"
WinningCandidate[which(WinningCandidate=="WILLIAM J. BRYAN")]<-"William Jennings Bryan"


#join to row
state_election_full<-cbind(state_election_full,WinningCandidate)
state_election_full$WinningCandidate<-tolower(state_election_full$WinningCandidate)

#join party to data
national_election$lowerPresident<-tolower(national_election$President)

state_election_complete<-left_join(state_election_full,national_election, by=c("Year", "WinningCandidate" = "lowerPresident"))
```

We can visualize the information using the mapping capabilities from `ggplot2`.  We produce a map of the United States for each voting year 1824 - 2016 and color each state with the winning party.  The Democratic party is in blue while the Republican party is in red.  Other parties are in various colors.

There is lots of interesting information here.  We see in 1860 that the south all voted for "Southern Democratic" party.  Abraham Lincoln won the election and we can see that in 1864, none of the South voted (this was during the Civil War).  It's also interesting to observe that the "Democratic" party used to be the conservative and state's rights party of the south.  From 1876 through about 1960, Texas and other deep south states were typically Democratic even when most of the other states were Republican.  After 1960, the south transitioned to becoming consistently Republican by 1980.  We can also see an emergence of the Democratic west coast, New England, and Great lakes states vs. a Republican midwest and south beginning in 1988. This is the pattern we have at present.

```{r,eval=TRUE,echo=FALSE,message=FALSE}

#join data together
state_election_map<-left_join(all_states,state_mapping,by=c("region" = "StateFullName_lower"))
state_election_map<-left_join(state_election_map,state_election_complete,by=c("StateAbbreviation" = "State"))

#assign colors to parties
state_election_map$PartyColor<-"gray"
state_election_map$Party<-str_trim(state_election_map$Party)
state_election_map$PartyColor[which(state_election_map$Party=="Republican")]<-"red"
state_election_map$PartyColor[which(state_election_map$Party=="Democratic")]<-"blue"
state_election_map$PartyColor[which(state_election_map$Party=="Democratic-Republican")]<-"wheat"
state_election_map$PartyColor[which(state_election_map$Party=="Southern Democratic")]<-"orange"
state_election_map$PartyColor[which(state_election_map$Party=="States' Rights")]<-"purple"
state_election_map$PartyColor[which(state_election_map$Party=="American Independent")]<-"yellow"
state_election_map$PartyColor[which(state_election_map$Party=="Progressive")]<-"green"
state_election_map$PartyColor[which(state_election_map$Party=="Populist")]<-"turquoise"
state_election_map$PartyColor[which(state_election_map$Party=="National-Republican")]<-"skyblue"
state_election_map$PartyColor[which(state_election_map$Party=="Whig")]<-"violet"
state_election_map$PartyColor[which(state_election_map$Party=="Constitutional Union")]<-"pink"
state_election_map$PartyColor[which(state_election_map$Party=="Whig-American")]<-"brown"
state_election_map$PartyColor[which(state_election_map$Party=="Anti-Masonic")]<-"limegreen"

#reorder to draw correctly
state_election_map<-arrange(state_election_map, Year, order)
```
```{r,eval=TRUE,echo=FALSE,message=FALSE, fig.width=10, fig.height=13}
#produce map
p <- ggplot()
p <- p + geom_polygon(data=state_election_map, aes(x=long, y=lat, group = group),colour="black", fill=state_election_map$PartyColor) + facet_wrap(~Year) + ggtitle("Winning Party By State Over Time")
p
```

While I made the above judgement about when "Democratic" and "Republican" switched in meaning using a visual analysis, can we mathematically determine when this changed?  The main assumption we have to make is that the states that started off as more national and liberal (in our modern sense) have stayed that way.  That is, they started off as "Republican" or "Whig", and at some point, when the meaning of "Republican" changed relative to "Democrat", these states become "Democratic" (in our present usage).  Similarly, states that started off more state-oriented and conservative (in our modern sense) have also stayed that way.  That is, they started off as "Democratic" or "Southern Democratic", and as the meaning of "Democrat" changed relative to "Republican", these states become "Republican" (in our modern sense).

My strategy then was to find the year at which a state switched from having a past of being "Democrat" to having a future of being "Republican", and vice versa.  I started with the year 1920, which is a year when the south is clearly Democratic in the old sense (conservative, state oriented) and the rest of the country is Republican in the old sense (liberal, national oriented), which contrasts with our present state/party orientation (south="Republican", most of the rest of the country = "Democrat").  I then assigned a 1 to each state for each year if the state was labeled as "Democratic" and a 0 if the state was labeled "Republican".  

I then found the year in which the running average over 10 elections for a Democratic (old sense) starting state switched from being above .5 to being below .5, indicating a switch to being "Republican" (current sense).  Similarly, I found the year when a starting Republican (old sense) state switched from being below .5 to being above .5 in the running average over 10 elections, meaning it had switched to being "Democratic" (current sense).  I averaged the years in which this switch occurred for all of the states in which a switch did occur.  This was the estimated year in which the meaning of "Democrat" and "Republican" switched to be more similar to the other term's previous meaning going forward.

Which year did I calculate?  The average was 1966.211, and the median was 1964.  This is consistent with my above visual conclusion, and it makes sense when we look at the map.  Before 1964, the southern states are regularly, although not always, Democrat as a group, even when the rest of the country is Republican (in 1948, they were the "State's Rights" party).  In 1964, the rest of the country is "Democratic", but the southern states as a group are "Republican" for the first time.  In 1968, the south votes for the "American Independent" party, but afterwards, apart from 1976, the south as a group regularly goes "Republican".  

```{r, eval=FALSE, echo=FALSE, warning=FALSE}
state_election_party<-subset(select(state_election_complete,State,Year,Party), Year>=1920)
state_election_party$Democratic<-NA
state_election_party$Party<-str_trim(state_election_party$Party)
state_election_party$Democratic[which(state_election_party$Party=="Democratic"|state_election_party$Party=="Southern Democratic")]<-1
state_election_party$Democratic[which(state_election_party$Party=="Republican"|state_election_party$Party=="National-Republican"|state_election_party$Party=="Whig")]<-0

yearswitch_df<-c()
yearswitch<-c()

for(stateid in unique(state_election_party$State)){
  #state<-"ID"
  temp<-subset(state_election_party,State==stateid)
  temp<-arrange(temp, Year)
  
  temp$Switch<-NA
  if (mean(temp$Democratic[1:11], na.rm=TRUE)>=.5){ #starts democrat
    for(j in 1:nrow(temp)){
      #j<-1
      avg<-mean(temp$Democratic[j:(j+10)], na.rm=TRUE) #avg over next 40 years (10 elections) is Democratic
      if(avg<=.5){
        temp$Switch[j]<-"yes"
      }
      
    }
  } else{#starts republican
    for(j in 1:nrow(temp)){
      #j<-1
      avg<-mean(temp$Democratic[j:(j+10)], na.rm=TRUE)
      if(avg>=.5){
        temp$Switch[j]<-"yes"
      }
      
    }
    
  }
  
  #find continuity of "switch" to avoid local change but not permanent change
  year_distance<-temp$Year[which(temp$Switch=="yes")]
  min_year<-c()
  if(length(year_distance)>0){
    for(k in 1:(length(year_distance)-1)){
    #k<-1
    if(year_distance[k+1]-year_distance[k]==4){
      min_year<-c(min_year,year_distance[k])
      }
    }
    
  }
  
  
  #get first year that switch occurred in continuity
 yearswitch<-min(min_year)
 yearswitch_df<-rbind(yearswitch_df,c(stateid, yearswitch))
  
}

#remove states that had no switch
yearswitch_df<-subset(data.frame(yearswitch_df, stringsAsFactors = FALSE), X2!=Inf)

#find average and median year that switch occurred for states
#mean(as.numeric(yearswitch_df$X2)) + 20 # add 20 years to find the middle year for the switch (average is over 40 years going forward from year)
#median(as.numeric(yearswitch_df$X2)) + 20

```

Before moving on, consider one last look at the map.  In particular, compare 1900 to 2012 (see below map).  Notice that they are almost exactly flipped: red states are now blue, and blue states are now red.  Now compare 2012 to 2016, and notice that many New England and Great Lakes states have switched from blue to red.  Could this be the start of another significant meaning change in the terms "Republican" and "Democrat"?  We shall have to wait and see.

```{r,eval=TRUE,echo=FALSE,message=FALSE, fig.width=10, fig.height=5}
#produce map
state_election_map_sub<-subset(state_election_map, Year %in% c(1900,2012,2016))
p <- ggplot()
p <- p + geom_polygon(data=state_election_map_sub, aes(x=long, y=lat, group = group),colour="black", fill=state_election_map_sub$PartyColor) + facet_wrap(~Year) + ggtitle("Winning Party By State Over Time")
p
```



#### Predicting Voter Turnout and Party

##### Voter Turnout

Can we predict voter turnout?  Let's start with a state's population ratio.  From the graph below, we can see that there isn't really any relationship.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.align="center"}
#population ratio to voting ratio
qplot(x = PopulationRatio, y = Ratio, data = subset(state, Year<=2015), main="State Population Ratio vs. State Voting Ratio") +geom_smooth(method="lm")
```

What about population density?  In order to calculate population density, we need to read in the square miles in each state.  This is done below.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE}
library(rvest)
library(XML)

#get state square miles
tables<-readHTMLTable("http://www.netstate.com/states/tables/st_size.htm", stringsAsFactors = FALSE)
state_square_miles<-tables[[1]]


header<-state_square_miles[3,]
state_square_miles<-state_square_miles[4:53,]
names(state_square_miles)<-header

#only keep land sq miles and state
state_square_miles<-state_square_miles[,4:5]

#clean
state_square_miles$`Land sq miles`<-as.numeric(str_replace_all(state_square_miles$`Land sq miles`,",",""))

#show head
kable(head(state_square_miles))
```

Now that we have the square miles of land per state, we can calculate the population density per state per year.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE}
#join to state_mapping
state_square_miles<-left_join(state_square_miles,state_mapping,by=c("State" = "StateFullName"))

#join to state data
state<-left_join(state,state_square_miles,by=c("State" = "StateAbbreviation"))
state$State.y<-NULL
state$StateFullName_lower<-NULL
state$StatePopulationDensity<-state$StatePopulation/state$`Land sq miles`
```

Does the state population density correlate with the voter turnout ratio?  As the plot below shows, there doesn't seem to much much of a relationship.  We get an R^2 value of 0.04, which doesn't mean much.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.align="center"}
qplot(x = StatePopulationDensity, y = Ratio, data = subset(state, Year<=2015), main="State Population Density vs. State Voting Ratio") +geom_smooth(method="lm")
summary(lm(Ratio~StatePopulationDensity, data=state))
```

What if we look at each state individually?  From the plot below, we can see that, for each state, as population density increases relative to the state, so does voter turnout.  But this is problematic since then we can't use population density as a common variable to predict voter turnout.

```{r,eval=TRUE,echo=FALSE,message=FALSE,, warning=FALSE, fig.width=10, fig.height=10}
qplot(x = StatePopulationDensity, y = Ratio, data = subset(state,!is.na(StatePopulationDensity),!is.na(Ratio)&Ratio!=0), main="State Population Density vs. State Voting Ratio by State") + facet_wrap(~State, scales = "free_x") + geom_smooth(method="lm")
```

What then do the states have in common that could account for an increase in voter turnout?  The commonality is the passage of time.  In the below plot, we use the Year to predict voter turnout for each state.  As you can see, the results for each state are fairly similar and approximately linear (although we do see a bit of a curve using the red `geom_smooth` line).  An aggregated view is also included.  R^2 using Year to predict voter turnout ratio is 0.38.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
qplot(x = Year, y = Ratio, data = subset(state, Year<=2015), main="State Voting Ratio Over Time") + facet_wrap(~State) + geom_smooth(method="lm")

```
```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.align="center"}
qplot(x = Year, y = Ratio, data = subset(state, Year<=2015 & Year>=1900), main="Voting Ratio Over Time") + geom_smooth(method="lm") + geom_smooth(colour="red")
summary(lm(Ratio~Year, data=state))
```

##### Party Prediction

Can we predict the winning party in any state using the population variables we have looked at?  I subset the data to only look at elections from 1970 onward so as to ensure that "Democratic" and "Republican" have roughly the same meaning as today.

In the first box plot comparing Party to the state population, we can see that there isn't much separation in the parties.  The same is true in the second box plot that uses population ratio.  However, the third box plot which uses population density does provide some noticeable separation.

```{r,eval=TRUE,echo=FALSE,message=FALSE, warning=FALSE, fig.align="center"}
## state population vs. party preference
state_population_party<-left_join(state,state_election_complete, by=c("Year","State"))

#show how population correlates to party preference (box plot, scatterplot)
state_population_party_sub<-subset(state_population_party,Year>=1970)
boxplot(state_population_party_sub$StatePopulation ~ state_population_party_sub$Party, main="1970 Onward: Population")

#population ratio
boxplot(state_population_party_sub$PopulationRatio ~ state_population_party_sub$Party, main="1970 Onward: Population Ratio")

#population density
boxplot(state_population_party_sub$StatePopulationDensity ~ state_population_party_sub$Party, main="1970 Onward: Population Density")

```

If we subset the data to only include elections from 1990 onward, we can see a similar but more pronounced pattern to what we saw above.  Both population and population ratio do not matter much, but population density matters a great deal.

```{r,eval=TRUE,echo=FALSE,message=FALSE, fig.align="center"}
state_population_party_sub<-subset(state_population_party,Year>=1990)

#population
boxplot(state_population_party_sub$StatePopulation ~ state_population_party_sub$Party, main="1990 Onward: Population")

#population proportion
boxplot(state_population_party_sub$PopulationRatio ~ state_population_party_sub$Party, main="1990 Onward: Population Ratio")

#population density
boxplot(state_population_party_sub$StatePopulationDensity ~ state_population_party_sub$Party, main="1990 Onward: Population Density")
```

Since population density seems to be a good predictor of party outcome, we can use this in a model.  Using all data from 1970 onward, we get an R^2 of 0.10.  For 1990 onward, 0.17.  For 2000 onward, 0.22.

```{r,eval=TRUE,echo=FALSE,message=FALSE, fig.align="center"}
state_population_party_sub<-subset(state_population_party,Year>=1970)
state_population_party_sub<-data.frame(state_population_party_sub)
state_population_party_sub<-select(state_population_party_sub,Year,StatePopulationDensity,Party)
state_population_party_sub<-state_population_party_sub[complete.cases(state_population_party_sub),]
state_population_party_sub$Party<-str_trim(state_population_party_sub$Party)
state_population_party_sub$Republican<-NA
state_population_party_sub$Republican[which(state_population_party_sub$Party=="Republican")]<-1
state_population_party_sub$Republican[which(state_population_party_sub$Party=="Democratic")]<-0

#predict Republican party using state population density
summary(lm(Republican~StatePopulationDensity, data=state_population_party_sub))
summary(lm(Republican~StatePopulationDensity, data=subset(state_population_party_sub, Year>=1990)))
summary(lm(Republican~StatePopulationDensity, data=subset(state_population_party_sub, Year>=2000)))

```

#### Conclusion

So what can we conclude?  It seems we can draw these various conclusions about population and voting trends in the United States.  The United States population as a whole is steadily increasing.  At the state level, however, some states are growing both absolutely or proportionally while others are not.

With respect to voting, while our current political situation is rather divisive, this is not uncommon in the past.  Divisive elections have swiftly been followed by relatively unified elections, and vice versa.  The political map of the United States has changed often, and will almost certainly change again.  So the current divisive situation should not lead us to despair.

What is encouraging is that the level of political participation through voting is higher than its ever been at the national level.  However, this increase does seem to be slowing down.  In individual states, it appears to have plateaued or decreased.  Such places present opportunities to make a renewed effort to "get out the vote".

Finally, population density seems to be a significant factor, especially more recently, in predicting party outcome.  It should not surprise us that in less populated states, where people live more independently, traditionally, and may not be in need of government assistance and coordinated social planning, a Republican platform (less government, traditional values, less taxation) would be more appealing.  As urbanization occurs requiring more social cooperation and interaction in meeting social needs and demands in an increasingly diverse population, it makes sense that a Democratic platform (social welfare, government programs and projects, heterogeneous values) would become more appealing.

This is certainly not the whole story (this would at most explain 20% of the variance in party preference), but it is reasonable interpretation of why population density aligns to significant degree with party preference.
